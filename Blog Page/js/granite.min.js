!function(e,t){t.Granite=t.Granite||{},t.Granite.$=t.Granite.$||e,t._g=t._g||{},t._g.$=t._g.$||e;var n=Granite.HTTP;e.ajaxSetup({externalize:!0,encodePath:!0,hook:!0,beforeSend:function(t,r){"undefined"!=typeof G_IS_HOOKED&&G_IS_HOOKED(r.url)||(r.externalize&&(r.url=n.externalize(r.url)),r.encodePath&&(r.url=n.encodePathOfURI(r.url))),r.hook&&(t=n.getXhrHook(r.url,r.type,r.data))&&(r.url=t.url,t.params&&("GET"===r.type.toUpperCase()?r.url+="?"+e.param(t.params):r.data=e.param(t.params)))},statusCode:{403:function(e){"Authentication Failed"===e.getResponseHeader("X-Reason")&&n.handleLoginRedirect()}}}),e.ajaxSettings.traditional=!0}(jQuery,this),window.Granite.csrf||(window.Granite.csrf=function(e){function t(){this._handler=[]}function n(e){var t="//"+document.location.host,n=document.location.protocol+t;return e===n||e.slice(0,n.length+1)===n+"/"||e===t||e.slice(0,t.length+1)===t+"/"||!/^(\/\/|http:|https:).*/.test(e)}function r(e){window.console&&console.warn("CSRF data not available;The data may be unavailable by design, such as during non-authenticated requests: "+e)}function o(){var e=new t;c=e;var n=new XMLHttpRequest;return n.onreadystatechange=function(){if(4===n.readyState)try{u=JSON.parse(n.responseText).token,e.resolve(u)}catch(t){r(t),e.reject(n.responseText)}},n.open("GET",p,!0),n.send(),e}function a(){var e=new XMLHttpRequest;e.open("GET",p,!1),e.send();try{return u=JSON.parse(e.responseText).token}catch(e){r(e)}}function i(e){var t=e.getAttribute("action");"GET"===e.method.toUpperCase()||t&&!n(t)||(u||a(),u&&((t=e.querySelector('input[name=":cq_csrf_token"]'))||((t=document.createElement("input")).setAttribute("type","hidden"),t.setAttribute("name",":cq_csrf_token"),e.appendChild(t)),t.setAttribute("value",u)))}function s(e){var t=function(e){"FORM"===(e=e.target).nodeName&&i(e)};e.addEventListener?e.addEventListener("submit",t,!0):e.attachEvent&&e.attachEvent("submit",t)}t.prototype={then:function(e,t){this._handler.push({resolve:e,reject:t})},resolve:function(){this._execute("resolve",arguments)},reject:function(){this._execute("reject",arguments)},_execute:function(e,t){if(null===this._handler)throw Error("Promise already completed.");for(var n=0,r=this._handler.length;n<r;n++)this._handler[n][e].apply(window,t);this.then=function(n,r){("resolve"===e?n:r).apply(window,t)},this._handler=null}};var c,u,p=e.externalize("/libs/granite/csrf/token.json");s(document);var l=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t,r){return"get"!==e.toLowerCase()&&n(t)&&(this._csrf=!0,this._async=r),l.apply(this,arguments)};var d=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(){if(this._csrf)if(u)this.setRequestHeader("CSRF-Token",u),d.apply(this,arguments);else if(!1===this._async)a(),u&&this.setRequestHeader("CSRF-Token",u),d.apply(this,arguments);else{var e=this,t=Array.prototype.slice.call(arguments);c.then((function(n){e.setRequestHeader("CSRF-Token",n),d.apply(e,t)}),(function(){d.apply(e,t)}))}else d.apply(this,arguments)};var h=HTMLFormElement.prototype.submit;if(HTMLFormElement.prototype.submit=function(){return i(this),h.apply(this,arguments)},window.Node){var f=Node.prototype.appendChild;Node.prototype.appendChild=function(){var e=f.apply(this,arguments);if("IFRAME"===e.nodeName)try{e.contentWindow&&!e._csrf&&(e._csrf=!0,s(e.contentWindow.document))}catch(t){e.src&&e.src.length&&n(e.src)&&window.console&&console.error("Unable to attach CSRF token to an iframe element on the same origin")}return e}}return o(),setInterval((function(){o()}),3e5),{initialised:!1,refreshToken:o,_clearToken:function(){u=void 0,o()}}}(window.Granite.HTTP));